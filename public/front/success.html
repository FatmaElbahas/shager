<!DOCTYPE html>
<html lang="ar">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­</title>
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <style>
        body {
            background: #f6f8fa;
            font-family: "Tajawal", sans-serif;
            text-align: center;
            padding-top: 100px;
        }

        .success-box {
            background: #fff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            display: inline-block;
        }

        .success-box h2 {
            color: #28a745;
            margin-bottom: 15px;
        }

        .success-box p {
            color: #555;
        }
    </style>
</head>

<body>
    <div class="success-box">
        <h2>âœ… ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!</h2>
        <p>Ø¬Ø§Ø±ÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ø´ØªØ±Ø§ÙƒÙƒ...</p>
    </div>

    <script>
        (async function () {
            const plan = localStorage.getItem("selectedPlan");
            const token = localStorage.getItem("authToken");
            const user = JSON.parse(localStorage.getItem("user"));

            if (!plan || !token || !user) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹");
                window.location.href = "joinus.html";
                return;
            }

            const startDate = new Date().toISOString().split("T")[0];
            let endDate = new Date();

            if (plan === "advanced") {
                endDate.setMonth(endDate.getMonth() + 3);
            } else {
                endDate.setFullYear(endDate.getFullYear() + 1);
            }

            const subscriptionData = {
                plan: plan,
                start_date: startDate,
                end_date: endDate.toISOString().split("T")[0],
                auto_renew: false,
                status: "active",
            };

            try {
                const response = await fetch("/api/subscriptions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${token}`,
                    },
                    body: JSON.stringify(subscriptionData),
                });

                const data = await response.json();

                if (response.ok) {
                    document.querySelector(".success-box p").textContent =
                        "ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙÙŠ Ø®Ø·Ø© " + plan + " Ø¨Ù†Ø¬Ø§Ø­ ğŸ‰";
                    localStorage.removeItem("selectedPlan");

                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ± ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
                    if (["advanced", "custom", "featured"].includes(plan)) {
                        const updatedUser = { ...user, role: "tree_creator" };
                        localStorage.setItem("user", JSON.stringify(updatedUser));
                    }
                } else {
                    document.querySelector(".success-box h2").textContent = "âŒ ÙØ´Ù„ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ";
                    document.querySelector(".success-box p").textContent =
                        data.message || "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹.";
                }
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:", error);
                document.querySelector(".success-box p").textContent =
                    "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØŒ Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù….";
            }
        })();
    </script>
</body>

</html>