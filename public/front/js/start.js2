const token = localStorage.getItem("authToken");
const user = JSON.parse(localStorage.getItem("user"));
// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù€ USER_ID Ù‡Ù†Ø§
window.USER_ID = user.id;

// ===============================
// Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø³Ù†Ø© - Start Page
// ===============================

function showCustomAlert(message, type = 'info', title = '', duration = 4000) {
  // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø±Ø³Ø§Ø¦Ù„ Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹
  const existingAlerts = document.querySelectorAll('.custom-alert');
  existingAlerts.forEach(alert => {
    alert.classList.add('hiding');
    setTimeout(() => alert.remove(), 300);
  });

  // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù† Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
  let icon, defaultTitle;
  switch(type) {
    case 'success':
      icon = 'âœ…';
      defaultTitle = 'ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!';
      break;
    case 'error':
      icon = 'âŒ';
      defaultTitle = 'Ø­Ø¯Ø« Ø®Ø·Ø£!';
      break;
    case 'warning':
      icon = 'âš ï¸';
      defaultTitle = 'ØªÙ†Ø¨ÙŠÙ‡!';
      break;
    case 'info':
    default:
      icon = 'â„¹ï¸';
      defaultTitle = 'Ù…Ø¹Ù„ÙˆÙ…Ø©';
      break;
  }

  // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
  const alertElement = document.createElement('div');
  alertElement.className = `custom-alert ${type}`;
  
  alertElement.innerHTML = `
    <div class="alert-header">
      <span class="alert-icon">${icon}</span>
      <h4 class="alert-title">${title || defaultTitle}</h4>
      <button class="alert-close" onclick="this.closest('.custom-alert').classList.add('hiding'); setTimeout(() => this.closest('.custom-alert').remove(), 300);">Ã—</button>
    </div>
    <p class="alert-message">${message}</p>
    <div class="alert-progress"></div>
  `;

  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„ØµÙØ­Ø©
  document.body.appendChild(alertElement);

  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
  setTimeout(() => {
    if (alertElement && alertElement.parentNode) {
      alertElement.classList.add('hiding');
      setTimeout(() => {
        if (alertElement && alertElement.parentNode) {
          alertElement.remove();
        }
      }, 300);
    }
  }, duration);

  return alertElement;
}

// Ø¯ÙˆØ§Ù„ Ù…Ø®ØµØµØ© Ù„ÙƒÙ„ Ù†ÙˆØ¹ Ø±Ø³Ø§Ù„Ø©
function showSuccessMessage(message, title = 'ØªÙ… Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰', duration = 4000) {
  return showCustomAlert(message, 'success', title, duration);
}

function showErrorMessage(message, title = 'Ø­Ø¯Ø« Ø®Ø·Ø£! âš ï¸', duration = 5000) {
  return showCustomAlert(message, 'error', title, duration);
}

function showWarningMessage(message, title = 'ØªÙ†Ø¨ÙŠÙ‡! âš ï¸', duration = 4000) {
  return showCustomAlert(message, 'warning', title, duration);
}

function showInfoMessage(message, title = 'Ù…Ø¹Ù„ÙˆÙ…Ø© â„¹ï¸', duration = 4000) {
  return showCustomAlert(message, 'info', title, duration);
}
document.addEventListener("DOMContentLoaded", function () {
  if (!token || !user || user.role !== "tree_creator") {
    showErrorMessage("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©. Ø³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.", "ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­! ğŸš«");
    setTimeout(() => {
      window.location.href = "shagertk.html";
    }, 2000);
    return;
  }
  
  // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨
  setTimeout(() => {
    showInfoMessage(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${user.name || 'Ø¨Ùƒ'}! Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„ØªÙƒ Ø§Ù„Ø¢Ù†.`, "Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹! ğŸ‘‹");
  }, 1000);

  // Sidebar toggle
  const sidebar = document.getElementById("sidebar");
  const toggler = document.querySelector(".navbar-toggler");
  const closeBtn = document.getElementById("close");

  toggler?.addEventListener("click", () => {
    sidebar.classList.toggle("show");
  });

  closeBtn?.addEventListener("click", () => {
    sidebar.classList.remove("show");
  });

  // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ active class Ù„Ù„Ø£ØµÙ†Ø§Ù ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
  document.querySelectorAll(".sidebar li").forEach((li) => {
    li.addEventListener("click", () => {
      document
        .querySelectorAll(".sidebar li")
        .forEach((item) => item.classList.remove("active"));
      li.classList.add("active");
    });
  });

  // ** ÙƒÙˆØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù„ÙˆØ¨ **
  document
    .querySelector(".nav-link.text-danger")
    .addEventListener("click", async function (e) {
      e.preventDefault();

      if (!token) {
        window.location.href = "login.html";
        return;
      }

      try {
        const response = await fetch("/api/logout", {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            Accept: "application/json",
          },
        });

        if (response.ok) {
          localStorage.removeItem("authToken");
          localStorage.removeItem("user");
          window.location.href = "login.html";
        } else {
          showErrorMessage("ÙØ´Ù„ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬! ğŸšª");
        }
      } catch (error) {
        showErrorMessage("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.", "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©! ğŸŒ");
      }
    });
});

document
  .getElementById("profile_image")
  .addEventListener("change", function (event) {
    const file = event.target.files[0];
    const previewImage = document.getElementById("previewImage");

    if (file) {
      const reader = new FileReader();

      reader.onload = function (e) {
        previewImage.src = e.target.result;
        previewImage.classList.remove("d-none");
        showSuccessMessage("ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!", "Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© ğŸ“¸", 2000);
      };

      reader.readAsDataURL(file);
    }
  });
function goToFatherModal() {
  console.log("Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...");
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  if (!token) {
    showErrorMessage("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©! ğŸ”");
    return;
  }
  
  if (!USER_ID) {
    showErrorMessage("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.", "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ø±Ù! ğŸ‘¤");
    return;
  }
  
  const firstModal = bootstrap.Modal.getInstance(
    document.getElementById("addUserModal")
  );
  
  if (firstModal) {
    firstModal.hide();
  } else {
    console.warn("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…ÙØªÙˆØ­");
  }

  const form = document.getElementById("userForm");
  
  if (!form) {
    showErrorMessage("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.", "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬! ğŸ“‹");
    return;
  }
  
  const formData = new FormData(form);
  formData.append("user_id", USER_ID);

  console.log("USER_ID:", USER_ID);
  console.log("Form data being sent:");
  for (let pair of formData.entries()) {
    console.log(pair[0] + ': ' + pair[1]);
  }

  const imageInput = document.getElementById("profile_image");
  if (imageInput && imageInput.files[0]) {
    formData.append("profile_image", imageInput.files[0]);
    console.log("ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ© Ù…Ø±ÙÙ‚Ø©:", imageInput.files[0].name);
  }

  // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙˆØªÙØ¹ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
  const continueBtn = document.querySelector('button[onclick="goToFatherModal()"]');
  const originalBtnText = continueBtn ? continueBtn.innerHTML : '';
  
  if (continueBtn) {
    continueBtn.disabled = true;
    continueBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
    continueBtn.classList.add('btn-loading');
  }

  fetch("/api/tree_creator/user-profiles", {
    method: "POST",
    headers: {
      Accept: "application/json",
      Authorization: `Bearer ${token}`,
    },
    body: formData,
  })
    .then((res) => {
      console.log("Response status:", res.status);
      console.log("Response ok:", res.ok);
      console.log("Response headers:", res.headers);
      
      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status} - ${res.statusText}`);
      }
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
      const contentType = res.headers.get('content-type');
      console.log("Content-Type:", contentType);
      
      if (!contentType || !contentType.includes('application/json')) {
        console.warn("Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„ÙŠØ³Øª JSONØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Øµ...");
        return res.text().then(text => {
          console.log("Response text:", text);
          try {
            return JSON.parse(text);
          } catch (e) {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† JSON ØµØ§Ù„Ø­ØŒ Ù†Ø¹ØªØ¨Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù†Ø§Ø¬Ø­Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† status 200
            return { success: true, message: "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­" };
          }
        });
      }
      
      return res.json();
    })
    .then((data) => {
      console.log("ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", data);
      console.log("Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©:", typeof data);
      console.log("Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", Object.keys(data));
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© - ØªØ¨Ø³ÙŠØ· Ø§Ù„Ø´Ø±Ø·
      const isSuccess = data && (
        data.success === true || 
        data.status === 'success' || 
        data.id || 
        data.user_id ||
        (data.message && !data.error)
      );
      
      console.log("Ù‡Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù†Ø§Ø¬Ø­Ø©ØŸ", isSuccess);
      
      if (isSuccess) {
        // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
        if (continueBtn) {
          continueBtn.innerHTML = '<i class="fas fa-check me-2"></i>ØªÙ… Ø§Ù„Ø­ÙØ¸!';
          continueBtn.classList.remove('btn-loading');
          continueBtn.classList.add('btn-success-state');
        }
        
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ø¨Ø¯ÙˆÙ† Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        const alertElement = showSuccessMessage("ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†' Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©.", "ØªÙ… Ø§Ù„Ø­ÙØ¸! ğŸ‘¤", 6000);
        
        // ØªÙØ¹ÙŠÙ„ Ø²Ø± "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†" Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const startNowBtn = document.getElementById('saveTreeBtn');
        if (startNowBtn) {
          // Ø¥Ø²Ø§Ù„Ø© event listener Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯
          startNowBtn.removeEventListener('click', startNowBtn._originalHandler);
          
          // ØªØ­Ø¯ÙŠØ« Ù…Ø¸Ù‡Ø± Ø§Ù„Ø²Ø±
          startNowBtn.disabled = false;
          startNowBtn.classList.remove('btn-secondary');
          startNowBtn.classList.add('btn-success');
          startNowBtn.innerHTML = '<i class="fas fa-rocket me-2"></i>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù† - Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ø´Ø¬Ø±Ø©';
          
          // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ù„Ù„ÙØª Ø§Ù„Ø§Ù†ØªØ¨Ø§Ù‡
          startNowBtn.style.animation = 'pulse 2s infinite';
          startNowBtn.style.boxShadow = '0 0 20px rgba(40, 167, 69, 0.5)';
          
          // Ø¥Ø¶Ø§ÙØ© event listener Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØªÙˆØ¬ÙŠÙ‡
          const newHandler = (e) => {
            e.preventDefault();
            redirectToShagertk();
          };
          startNowBtn.addEventListener('click', newHandler);
          startNowBtn._newHandler = newHandler;
        }
      } else {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø²Ø± Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        if (continueBtn) {
          continueBtn.disabled = false;
          continueBtn.innerHTML = originalBtnText;
          continueBtn.classList.remove('btn-loading', 'btn-success-state');
        }
        throw new Error(data.message || "ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
      }
    })
    .catch((err) => {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", err);
      showErrorMessage(`ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${err.message}. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.`, "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸! ğŸ’¾");
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø²Ø± Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
      if (continueBtn) {
        continueBtn.disabled = false;
        continueBtn.innerHTML = originalBtnText;
        continueBtn.classList.remove('btn-loading', 'btn-success-state');
      }
    });
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© shagertk.html Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†"
function redirectToShagertk() {
  console.log("ğŸš€ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†' - Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡");
  
  // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± ÙˆØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„ØªÙ‡
  const startBtn = document.getElementById('saveTreeBtn');
  if (startBtn) {
    startBtn.disabled = true;
    startBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡...';
    startBtn.classList.remove('btn-success');
    startBtn.classList.add('btn-info');
    startBtn.style.animation = 'none';
    startBtn.style.boxShadow = 'none';
  }
  
  // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
  showInfoMessage("Ø¬Ø§Ø±ÙŠ ØªÙˆØ¬ÙŠÙ‡Ùƒ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©...", "Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ ğŸš€", 2000);
  
  // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù…Ø¹ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª
  setTimeout(() => {
    try {
      console.log("ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ shagertk.html");
      
      // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: window.location.href
      window.location.href = "shagertk.html";
      
      // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: window.location.replace (Ø¨Ø¹Ø¯ 300ms)
      setTimeout(() => {
        if (window.location.pathname.includes('start.html')) {
          console.log("ğŸ”„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ø§Ø³ØªØ®Ø¯Ø§Ù… window.location.replace");
          window.location.replace("shagertk.html");
        }
      }, 300);
      
      // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©: window.location.assign (Ø¨Ø¹Ø¯ 600ms)
      setTimeout(() => {
        if (window.location.pathname.includes('start.html')) {
          console.log("ğŸ”„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©: Ø§Ø³ØªØ®Ø¯Ø§Ù… window.location.assign");
          window.location.assign("shagertk.html");
        }
      }, 600);
      
    } catch (error) {
      console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡:", error);
      
      // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©: window.open
      try {
        window.open("shagertk.html", "_self");
      } catch (finalError) {
        console.error("âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„ØªÙˆØ¬ÙŠÙ‡:", finalError);
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
        if (startBtn) {
          startBtn.disabled = false;
          startBtn.innerHTML = '<i class="fas fa-rocket me-2"></i>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†';
          startBtn.classList.remove('btn-info');
          startBtn.classList.add('btn-success');
        }
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ø±Ø§Ø¨Ø· ÙŠØ¯ÙˆÙŠ
        showErrorMessage(
          'ØªØ¹Ø°Ø± Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ. ÙŠØ±Ø¬Ù‰ <a href="shagertk.html" style="color: #fff; text-decoration: underline; font-weight: bold;">Ø§Ù„Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹</a>',
          "Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡! ğŸ”„",
          8000
        );
      }
    }
  }, 1000);
}

const urlParams = new URLSearchParams(window.location.search);
const treeId = urlParams.get("template_id");

async function loadTree() {
  try {
    const response = await fetch(
      `/api/family-trees/${treeId}`,
      {
        headers: {
          Accept: "application/json",
          Authorization: `Bearer ${token}`,
        },
      }
    );
    const data = await response.json();

    if (response.ok) {
      const templateId = data.template_id;
      renderTree(templateId, data.members); // Ù†Ù…Ø±Ø± Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª + Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
    } else {
      showErrorMessage("ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø¬Ø±Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„! ğŸ“Š");
    }
  } catch (error) {
    console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø¬Ø±Ø©:", error);
  }
}

// form

let selectedTemplateId = null;

document.querySelectorAll(".choose-template").forEach((btn) => {
  btn.addEventListener("click", function () {
    selectedTemplateId = this.dataset.templateId;

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    document.querySelectorAll(".choose-template").forEach((b) => {
      b.classList.remove("selected");
      b.innerHTML = "Ø§Ø®ØªØ±"; // Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ
    });

    // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±
    this.classList.add("selected");
    this.innerHTML =
      '<i class="fas fa-check" style="color: rgba(162, 124, 42, 1);"></i> ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ù„Ø¨';
    
    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
    showSuccessMessage(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø±Ù‚Ù… ${selectedTemplateId} Ø¨Ù†Ø¬Ø§Ø­!`, "ØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±! âœ¨");
  });
});

// Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø¬Ø¹ Ù„Ù„Ù€ event listener Ø§Ù„Ø£ØµÙ„ÙŠ
const originalSaveTreeHandler = async function () {
    const saveBtn = this;
    const originalText = saveBtn.innerHTML;
    
    const treeName = document.getElementById("treeName").value;
    const logoImage = document.getElementById("logoInput").files[0];
    const coverImage = document.getElementById("coverInput").files[0];
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø´Ø¬Ø±Ø©
    if (!treeName || treeName.trim() === "") {
      showWarningMessage("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.", "Ø§Ø³Ù… Ø§Ù„Ø´Ø¬Ø±Ø© Ù…Ø·Ù„ÙˆØ¨! ğŸ“");
      document.getElementById("treeName").focus();
      return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ù„Ø¨
    if (!selectedTemplateId) {
      showWarningMessage("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø§Ù„Ø¨ Ù„Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.", "Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ù„Ø¨ Ù…Ø·Ù„ÙˆØ¨! ğŸ¨");
      return;
    }

    // ØªÙØ¹ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...';
    saveBtn.classList.add('btn-loading');

    // Ù†Ø¬Ù‡Ø² Ø§Ù„ÙÙˆØ±Ù… Ø¯Ø§ØªØ§
    const formData = new FormData();
    formData.append("tree_name", treeName);
    if (selectedTemplateId) {
      formData.append("template_id", selectedTemplateId);
    }
    if (logoImage) {
      formData.append("logo_image", logoImage);
    }
    if (coverImage) {
      formData.append("cover_image", coverImage);
    }

    try {
      const response = await fetch(
        "/api/tree_creator/family-trees",
        {
          method: "POST",
          headers: {
            Accept: "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: formData,
        }
      );

      const data = await response.json();

      if (response.ok) {
        showSuccessMessage("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø¬Ø±Ø© Ø§Ù„Ø¢Ù†.", "ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡! ğŸŒ³");
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
        saveBtn.innerHTML = '<i class="fas fa-check me-2"></i>ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡!';
        saveBtn.classList.remove('btn-loading');
        saveBtn.classList.add('btn-success-state');
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø´Ø¬Ø±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        setTimeout(() => {
          window.location.href = `shagertk.html?tree_id=${data.tree_id}`;
        }, 2000);
        console.log(data);
      } else {
        showErrorMessage(
          "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ø¬Ø±Ø©: " + (data.message || "ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©"),
          "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡! ğŸŒ³"
        );
        console.error(data);
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø²Ø± ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
        saveBtn.classList.remove('btn-loading', 'btn-success-state');
      }
    } catch (error) {
      showErrorMessage("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©! ğŸŒ");
      console.error(error);
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø²Ø± ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
      saveBtn.disabled = false;
      saveBtn.innerHTML = originalText;
      saveBtn.classList.remove('btn-loading', 'btn-success-state');
    }
};

// Ø¥Ø¶Ø§ÙØ© event listener Ù„Ù„Ø²Ø± Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener("DOMContentLoaded", function() {
  const saveTreeBtn = document.getElementById("saveTreeBtn");
  if (saveTreeBtn) {
    saveTreeBtn.addEventListener("click", originalSaveTreeHandler);
    saveTreeBtn._originalHandler = originalSaveTreeHandler;
  }
});

// Ø²Ø±Ø§Ø± ÙŠÙØªØ­ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„ØºÙ„Ø§Ù
document.getElementById("coverBtn").addEventListener("click", function () {
  document.getElementById("coverInput").click();
});

// Preview Ù„ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù
document.getElementById("coverInput").addEventListener("change", function (e) {
  if (e.target.files && e.target.files[0]) {
    document.getElementById("coverPreview").src = URL.createObjectURL(
      e.target.files[0]
    );
    showSuccessMessage("ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù Ø¨Ù†Ø¬Ø§Ø­!", "ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù ğŸ–¼ï¸", 2000);
  }
});

// Ø²Ø±Ø§Ø± ÙŠÙØªØ­ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„Ø´Ø¹Ø§Ø±
document.getElementById("logoBtn").addEventListener("click", function () {
  document.getElementById("logoInput").click();
});

// Preview Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©
document.getElementById("logoInput").addEventListener("change", function (e) {
  if (e.target.files && e.target.files[0]) {
    document.getElementById("logoPreview").src = URL.createObjectURL(
      e.target.files[0]
    );
    showSuccessMessage("ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!", "Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© ğŸ ", 2000);
  }
});
